---
title: "EDA of DC Zillow Listings Vs AirBnB"
author: "Bryan Johns"
date: "2025-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(devtools)
library(tibble)
library(ggplot2)
library(scales)
library(dplyr)
library(tidyr)
load_all("../..")
```

# DC AirBnB Vs Zillow listings

Loading the Zillow data:

```{r, echo=FALSE}
re_df <- read_real_estate_json()
re_df <- as_tibble(re_df)
head(re_df)
```
Loading the AirBnB data, which drops a few errors ($7000 hostel beds that should be $70):

```{r, echo=FALSE}
adf <- read_airbnb_csv()
head(adf)
```

Assign neighborhoods to the Zillow data. This drops 6 rows lacking lat/long coordinates.

```{r, echo=FALSE}
zdf <- assign_neighborhood(re_df)
zdf <- as_tibble(zdf)
head(zdf)
```
Verify that neighborhoods have been assigned correctly:

```{r, echo=FALSE}
ggplot(zdf, aes(x = longitude, y = latitude, color = neighborhood == "Unknown")) +
  geom_point(alpha = 0.7) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(title = "Spatial Distribution of Zillow Listings",
       subtitle = "Checking that listings are assigned to DC neighborhoods",
       color = "Unknown Neighborhood") +
  theme_minimal()
```

The black plots are in DC, Red in Virginia and Maryland.

Neighborhood counts:

```{r, echo=FALSE}
zdf %>%
  count(shortNeighborhood, sort = TRUE)
```

Drop unknown neighborhoods and see if neighborhoods coded correctly:

```{r, echo=FALSE}
zdf <- zdf[zdf$neighborhood != "Unknown", ]
ggplot(zdf, aes(x = longitude, y = latitude, color = neighborhood)) +
  geom_point(alpha = 0.7) +
  labs(title = "Spatial Distribution of Zillow Listings",
       subtitle = "Checking that listings are assigned to DC neighborhoods",
       color = "Neighborhood") +
  theme_minimal() +
  theme(legend.position = "none") # neighborhood names squish out the plot
```

And the AirBnB's:

```{r, echo=FALSE}
ggplot(adf, aes(x = longitude, y = latitude, color = neighborhood)) +
  geom_point(alpha = 0.7) +
  labs(title = "Spatial Distribution of AirBnB Listings",
       # subtitle = "Checking that listings are assigned to DC neighborhoods",
       color = "Neighborhood") +
  theme_minimal() +
  theme(legend.position = "none") # neighborhood names squish out the plot
```

## Average Price

```{r, echo=FALSE}
# calculate average price by neighborhood for zdf...
zdf_avg_price <- zdf %>%
  group_by(shortNeighborhood) %>%
  summarize(avg_price_zillow = mean(price, na.rm = TRUE))

# ...and adf
adf_avg_price <- adf %>%
  group_by(shortNeighborhood) %>%
  summarize(avg_price_airbnb = mean(price, na.rm = TRUE))

# join as a df
combined_avg_price <- full_join(zdf_avg_price, adf_avg_price, by = "shortNeighborhood")

# get total average price, add to df
total_avg_price_zillow <- mean(zdf$price, na.rm = TRUE)
total_avg_price_airbnb <- mean(adf$price, na.rm = TRUE)
combined_avg_price <- combined_avg_price %>%
  add_row(shortNeighborhood = "Total", avg_price_zillow = total_avg_price_zillow, avg_price_airbnb = total_avg_price_airbnb)

# calculate percent change from total average price for each neighborhood
combined_avg_price <- combined_avg_price %>%
  mutate(
    change_zillow = (avg_price_zillow - total_avg_price_zillow) / total_avg_price_zillow * 100,
    change_airbnb = (avg_price_airbnb - total_avg_price_airbnb) / total_avg_price_airbnb * 100
  )

# format
combined_avg_price_formatted <- combined_avg_price %>%
  mutate(
    avg_price_zillow = dollar(avg_price_zillow, accuracy = 0.01),
    avg_price_airbnb = dollar(avg_price_airbnb, accuracy = 0.01),
    change_zillow = percent(change_zillow / 100, accuracy = 0.01),
    change_airbnb = percent(change_airbnb / 100, accuracy = 0.01)
  )

print(combined_avg_price_formatted)
```

Create a scatterplot comparing percent change in Zillow versus percent change in Airbnb:

```{r, echo=FALSE}
ggplot(combined_avg_price, aes(x = avg_price_zillow, y = avg_price_airbnb)) +
  geom_point() +
  # geom_text(aes(label = shortNeighborhood), vjust = -0.5, hjust = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Zillow vs Airbnb Prices by Neighborhood",
       x = "Zillow Prices",
       y = "Airbnb Prices") +
  theme_minimal()
```


It doesn't look like much of a correlation. Let's prove it. Test for fit:

```{r, echo=FALSE}
# Fit a linear model
fit <- lm(avg_price_airbnb ~ avg_price_zillow, data = combined_avg_price)

# Print the summary of the linear model
summary(fit)
```

Conclusion:

AirBnB prices have little to do with Zillow prices (on the neighborhood level) - perhaps because the neighborhoods are not subdivided enough, perhaps because vacationers are looking for different things than home buyers?

```{r, echo=FALSE}
ggplot() +
  # geom_boxplot(data = adf, aes(x = shortNeighborhood, y = price, fill = "Airbnb"), alpha = 0.5) +
  geom_boxplot(data = zdf, aes(x = shortNeighborhood, y = price, fill = "Zillow"), alpha = 0.5) +
  scale_fill_manual(values = "blue") +
  labs(title = "Airbnb vs Zillow Prices by Neighborhood", x = "Neighborhood", y = "Price") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_flip()
  # theme(legend.position = "none", axis.text.x = element_text(angle = 90, hjust = 1)) # +
  # coord_flip()
```

```{r, echo=FALSE}
ggplot() +
  geom_boxplot(data = adf, aes(x = shortNeighborhood, y = price, fill = "Airbnb"), alpha = 0.5) +
  # geom_boxplot(data = zdf, aes(x = shortNeighborhood, y = price, fill = "Zillow"), alpha = 0.5) +
  scale_fill_manual(values = "red") +
  labs(title = "Airbnb vs Zillow Prices by Neighborhood", x = "Neighborhood", y = "Price") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_flip()
```

## Median Price

```{r, echo=FALSE}
airbnb_summary <- adf %>%
  group_by(shortNeighborhood) %>%
  summarise(median_airbnb_price = median(price, na.rm = TRUE))
airbnb_summary
```

```{r, echo=FALSE}
zillow_summary <- zdf %>%
  group_by(shortNeighborhood) %>%
  summarise(median_zillow_price = median(price, na.rm = TRUE))
zillow_summary
```


```{r, echo=FALSE}
library(tidyr)

heatmap_df <- full_join(
  airbnb_summary, zillow_summary, by = "shortNeighborhood"
) %>%
  pivot_longer(cols = c(median_airbnb_price, median_zillow_price),
               names_to = "Type", values_to = "Price")

ggplot(heatmap_df, aes(x = shortNeighborhood, y = Type, fill = Price)) +
  geom_tile() +
  scale_fill_gradient(low = "yellow", high = "red") +
  theme_minimal() +
  labs(title = "Heatmap of Median Airbnb vs Zillow Prices", x = "Neighborhood", y = "Type") +
  coord_flip()

```

